---
import { getAllCategories, getPostsByCategory } from '../../lib/api';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import ArchivePostCard from '../../components/ArchivePostCard.astro';
import { ClientRouter } from 'astro:transitions';

export async function getStaticPaths() {
  const categories = await getAllCategories();
  return categories.map((cat) => ({
    params: { slug: cat.slug || cat.name.toLowerCase().replace(/\s+/g, '-') },
    props: { category: cat },
  }));
}

const { category } = Astro.props;
// Initial Fetch
const { nodes: initialPosts, pageInfo } = await getPostsByCategory(category.name, 6);
const title = `${category.name} Case Studies - The Times Clock`;
const description = `Read the best ${category.name} case studies and business stories on The Times Clock.`;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <ClientRouter />
    
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">
  </head>
  <body class="bg-white font-['Inter',sans-serif] antialiased text-gray-900 flex flex-col min-h-screen">
    <Navbar />
    
    <main class="flex-grow max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 py-12 w-full">
      
      <!-- PAGE HEADER -->
      <div class="mb-16">
          <span class="text-xs font-bold text-red-600 uppercase tracking-widest mb-2 block">ARCHIVE</span>
          <h1 class="text-3xl md:text-6xl font-black tracking-tighter text-gray-900 mb-4 uppercase">{category.name}</h1>
          <p class="text-gray-500 max-w-2xl text-lg">{category.description || `Deep dives into ${category.name} and related business strategies.`}</p>
      </div>

      <!-- POST GRID -->
      <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
          {initialPosts.map(post => (
              <ArchivePostCard post={post} categoryName={category.name} />
          ))}
      </div>

      <!-- PAGINATION -->
      <div class="flex justify-center" id="load-more-container">
        {pageInfo.hasNextPage && (
          <button 
            id="load-more-btn"
            data-category={category.name}
            data-cursor={pageInfo.endCursor}
            class="bg-black text-white font-bold text-xs uppercase tracking-widest px-8 py-4 rounded-full hover:bg-gray-800 transition-transform active:scale-95 shadow-lg"
          >
            Load More Stories
          </button>
        )}
      </div>

    </main>

    <Footer />

    <script define:vars={{ initialHasNextPage: pageInfo.hasNextPage, initialEndCursor: pageInfo.endCursor, currentCategory: category.name }}>
        let hasNextPage = initialHasNextPage;
        let endCursor = initialEndCursor;
        const postsGrid = document.getElementById('posts-grid');
        const loadMoreBtn = document.getElementById('load-more-btn');

        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', async () => {
                if (!hasNextPage || loadMoreBtn.disabled) return;
                
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Loading...';

                try {
                    // Use server-provided category name directly
                    const url = `/api/posts.json?category=${encodeURIComponent(currentCategory)}&limit=2&after=${encodeURIComponent(endCursor)}`;
                    console.log('Fetching:', url);
                    
                    const res = await fetch(url);
                    if (!res.ok) {
                         const text = await res.text();
                         throw new Error(`HTTP ${res.status}: ${text}`);
                    }
                    
                    const data = await res.json();

                    if (data.error) throw new Error(data.error);

                    if (data.nodes && data.nodes.length > 0) {
                        data.nodes.forEach(post => {
                           const html = createPostCardHtml(post, currentCategory);
                           const tempDiv = document.createElement('div');
                           tempDiv.innerHTML = html;
                           const article = tempDiv.firstElementChild; 
                           if(article) postsGrid.appendChild(article);
                        });

                        hasNextPage = data.pageInfo.hasNextPage;
                        endCursor = data.pageInfo.endCursor;
                    } else {
                        hasNextPage = false;
                        alert('No more posts found.');
                    }

                    if (!hasNextPage) {
                        loadMoreBtn.remove();
                    } else {
                         loadMoreBtn.disabled = false;
                         loadMoreBtn.textContent = 'Load More Stories';
                    }

                } catch (err) {
                    console.error('Failed to load posts', err);
                    alert(`Error: ${err.message}\nCategory: ${currentCategory}`);
                    loadMoreBtn.textContent = 'Try Again';
                    loadMoreBtn.disabled = false;
                }
            });
        }

        function createPostCardHtml(post, categoryName) {
            const date = new Date(post.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            const imgSrc = post.featuredImage?.node?.sourceUrl;
            const author = post.author?.node?.name || 'Editor';
            const avatar = post.author?.node?.avatar?.url;

            let imageHtml = '';
            if (imgSrc) {
                imageHtml = `<img src="${imgSrc}" alt="${post.title}" class="absolute inset-0 w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500" />`;
            } else {
                imageHtml = `
                <div class="absolute inset-0 w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 group-hover:scale-105 transition-transform duration-500">
                     <img src="/logo.png" alt="The Times Clock" class="w-16 h-16 object-contain opacity-50 grayscale" />
                </div>`;
            }
            
            return `
            <article class="bg-white rounded-2xl p-4 hover:shadow-xl transition-shadow duration-300 border border-gray-100 flex flex-col sm:flex-row gap-6 items-stretch h-full animate-fade-in">
              <!-- Image Section (40%) -->
              <a href="/post/${post.slug}" class="w-full sm:w-2/5 shrink-0 block relative group overflow-hidden rounded-xl aspect-video sm:aspect-auto sm:h-auto bg-gray-100">
                ${imageHtml}
              </a>

              <!-- Content Section (60%) -->
              <div class="flex-1 flex flex-col py-1">
                
                <!-- Header: Label -->
                <div class="mb-3">
                    <span class="inline-block px-2 py-0.5 rounded text-[10px] sm:text-[11px] font-bold bg-[#a855f7]/10 text-[#a855f7] uppercase tracking-wider border border-[#a855f7]/20">
                        ${categoryName || 'Case Study'}
                    </span>
                </div>

                <!-- Title -->
                <a href="/post/${post.slug}" class="group">
                    <h3 class="text-xl font-bold text-gray-900 leading-tight mb-3 group-hover:text-blue-600 transition-colors">
                        ${post.title}
                    </h3>
                </a>

                <!-- Analyst Breakdown (Checklist) -->
                <div class="mb-6">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Analyst Breakdown</p>
                    <ul class="space-y-1.5">
                        ${(() => {
                            let points = [];
                            if (post.content) {
                                // Try to find list items first
                                const listMatches = post.content.match(/<li>(.*?)<\/li>/g);
                                if (listMatches) {
                                    points = listMatches.slice(0, 3).map(item => item.replace(/<\/?li>/g, '').replace(/<[^>]*>/g, '').trim());
                                }
                                
                                // If no list items, split by sentences
                                if (points.length === 0) {
                                    const sentences = post.content.replace(/<[^>]*>/g, '').split(/[.!?]/).filter(s => s.trim().length > 10);
                                    points = sentences.slice(0, 3).map(s => s.trim());
                                }
                            }
                            
                            // Fallback defaults if extraction fails
                            if (points.length === 0) {
                                points = [
                                    "Revenue model & margins",
                                    "Customer acquisition strategy",
                                    "Tech stack & scaling tools"
                                ];
                            }
                            
                            // Ensure always 3 items for layout consistency
                            while (points.length < 3) {
                                points.push("Business strategy & insights");
                            }
                            
                            return points.slice(0, 3).map(point => `
                                <li class="flex items-center gap-2 text-xs font-medium text-gray-600">
                                    <svg class="w-3.5 h-3.5 text-green-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>
                                    <span class="line-clamp-1">${point}</span>
                                </li>
                            `).join('');
                        })()}
                    </ul>
                </div>

                <!-- Footer: Author & Date -->
                <div class="mt-auto flex items-center gap-3 pt-4 border-t border-gray-100">
                    ${avatar ? `<img src="${avatar}" alt="${author}" class="w-6 h-6 rounded-full" />` : ''}
                    <span class="text-xs font-bold text-gray-900">${author}</span>
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider ml-auto">${date}</span>
                </div>
              </div>
            </article>
            `;
        }
    </script>
    <style is:global>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
  </body>
</html>
